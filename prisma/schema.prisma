// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  clerkId       String    @unique // Clerk user ID
  email         String    @unique
  firstName     String?
  lastName      String?
  company       String?
  phone         String?
  role          UserRole  @default(DISPATCHER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  customers     Customer[]
  loads         Load[]
  quotes        Quote[]
  routes        SavedRoute[]

  @@map("users")
}

enum UserRole {
  ADMIN
  DISPATCHER
  DRIVER
  VIEWER
}

// ============================================
// CUSTOMER MANAGEMENT
// ============================================

model Customer {
  id            String    @id @default(cuid())
  name          String
  contactName   String?
  email         String?
  phone         String?
  address       String?
  city          String?
  state         String?
  zipCode       String?
  notes         String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  loads         Load[]
  quotes        Quote[]

  @@map("customers")
}

// ============================================
// LOAD MANAGEMENT
// ============================================

model Load {
  id            String      @id @default(cuid())
  loadNumber    String      @unique @default(cuid())
  status        LoadStatus  @default(DRAFT)

  // Origin & Destination
  origin        String
  originCity    String?
  originState   String?
  destination   String
  destCity      String?
  destState     String?

  // Cargo Details
  description   String?
  cargoType     String?

  // Primary Dimensions (feet)
  length        Float
  width         Float
  height        Float
  weight        Float       // pounds

  // Additional Items
  items         LoadItem[]

  // Route Info
  statesTraversed String[]
  totalDistance   Float?    // miles
  totalDuration   Float?    // hours

  // Costs
  permitCost      Float     @default(0)
  escortCost      Float     @default(0)
  fuelCost        Float     @default(0)
  tollCost        Float     @default(0)
  lineHaulRate    Float?
  totalCost       Float     @default(0)

  // Dates
  pickupDate      DateTime?
  deliveryDate    DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  quotes          Quote[]
  trailerType     String?   // flatbed, step-deck, rgn, lowboy, double-drop

  @@map("loads")
}

model LoadItem {
  id            String    @id @default(cuid())
  name          String
  length        Float     // feet
  width         Float     // feet
  height        Float     // feet
  weight        Float     // pounds
  quantity      Int       @default(1)

  // Position on trailer (for visualization)
  positionX     Float     @default(0)
  positionY     Float     @default(0)
  positionZ     Float     @default(0)
  color         String    @default("#3b82f6")

  loadId        String
  load          Load      @relation(fields: [loadId], references: [id], onDelete: Cascade)

  @@map("load_items")
}

enum LoadStatus {
  DRAFT
  QUOTED
  BOOKED
  DISPATCHED
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

// ============================================
// QUOTE MANAGEMENT
// ============================================

model Quote {
  id              String      @id @default(cuid())
  quoteNumber     String      @unique
  status          QuoteStatus @default(DRAFT)

  // Quote Details
  validUntil      DateTime?
  notes           String?
  terms           String?

  // Line Items
  lineItems       QuoteLineItem[]

  // Totals
  subtotal        Float       @default(0)
  taxRate         Float       @default(0)
  taxAmount       Float       @default(0)
  total           Float       @default(0)

  // Dates
  sentAt          DateTime?
  acceptedAt      DateTime?
  declinedAt      DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  customerId      String?
  customer        Customer?   @relation(fields: [customerId], references: [id], onDelete: SetNull)
  loadId          String?
  load            Load?       @relation(fields: [loadId], references: [id], onDelete: SetNull)

  @@map("quotes")
}

model QuoteLineItem {
  id            String    @id @default(cuid())
  description   String
  category      String    // line_haul, permit, escort, fuel, toll, other
  quantity      Float     @default(1)
  unitPrice     Float
  total         Float
  notes         String?

  quoteId       String
  quote         Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@map("quote_line_items")
}

enum QuoteStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  DECLINED
  EXPIRED
}

// ============================================
// SAVED ROUTES
// ============================================

model SavedRoute {
  id              String    @id @default(cuid())
  name            String
  origin          String
  destination     String
  statesTraversed String[]

  // Cargo specs used
  cargoWidth      Float
  cargoHeight     Float
  cargoLength     Float
  cargoWeight     Float

  // Costs snapshot
  permitCost      Float     @default(0)
  escortCost      Float     @default(0)
  fuelCost        Float     @default(0)
  tollCost        Float     @default(0)
  totalCost       Float     @default(0)

  // Route data
  totalDistance   Float?
  totalDuration   Float?
  stateDistances  Json?     // { "TX": 150, "OK": 200, ... }

  isFavorite      Boolean   @default(false)
  usedCount       Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("saved_routes")
}

// ============================================
// ACTIVITY LOG
// ============================================

model ActivityLog {
  id          String    @id @default(cuid())
  action      String    // created, updated, deleted, viewed, sent, etc.
  entityType  String    // load, quote, customer, route
  entityId    String
  details     Json?
  createdAt   DateTime  @default(now())

  userId      String?

  @@index([entityType, entityId])
  @@index([userId])
  @@map("activity_logs")
}

// ============================================
// SHAREABLE LINKS
// ============================================

model ShareToken {
  id            String          @id @default(cuid())
  token         String          @unique @default(cuid())
  entityType    ShareEntityType
  entityId      String

  // Permissions
  allowDownload Boolean         @default(true)
  allowPrint    Boolean         @default(true)

  // Security
  password      String?         // Hashed password (null = no password required)
  maxAccessCount Int?           // Max views allowed (null = unlimited)

  // Expiration
  expiresAt     DateTime?
  autoExtend    Boolean         @default(false)  // Auto-extend when accessed
  extendDays    Int             @default(7)      // Days to extend by

  // Access tracking
  viewCount     Int             @default(0)
  downloadCount Int             @default(0)
  printCount    Int             @default(0)
  lastViewedAt  DateTime?

  // Metadata
  createdAt     DateTime        @default(now())
  createdById   String

  // Relations
  accessLogs    ShareAccessLog[]

  @@index([token])
  @@index([entityType, entityId])
  @@map("share_tokens")
}

model ShareAccessLog {
  id            String    @id @default(cuid())
  shareTokenId  String
  shareToken    ShareToken @relation(fields: [shareTokenId], references: [id], onDelete: Cascade)

  action        String    // view, download, print
  ipAddress     String?
  userAgent     String?
  country       String?
  city          String?

  createdAt     DateTime  @default(now())

  @@index([shareTokenId])
  @@map("share_access_logs")
}

enum ShareEntityType {
  QUOTE
  LOAD
}
